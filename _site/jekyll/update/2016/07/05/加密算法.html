<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>IOS常用加密算法</title>
  <meta name="description" content="5.1 通过简单的URLENCODE ＋ BASE64编码防止数据明文传输5.2 对普通请求、返回数据，生成MD5校验（MD5中加入动态密钥），进行数据完整性（简单防篡改，安全性较低，优点：快速）校验。 5.3 对于重要数据，使用RSA进行数字签名，起到防篡改作用。5.4 对于比较敏感的数据，如用户信息（登陆、注...">

  <link rel="stylesheet" href="/css/main.css" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="canonical" href="https://muinch.github.io/jekyll/update/2016/07/05/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95.html">
  <link rel="alternate" type="application/rss+xml" title="木瓜" href="https://muinch.github.io/feed.xml">
</head>


  <body>

    <header> 
    <div>
      <div id="textlogo">
        <h1 class="site-name"><a href="/" title="瓜的技术博客">木瓜</a></h1>
        <h2 class="blog-motto">随意写写，记录生活点滴～～</h2>
      </div>
      <nav class="animated">
          <ul>
              <li><a href="/">首页</a></li>
              <li><a href="/about/">关于</a></li>
          </ul>
      </nav>   
    </div>
</header>

<div id="container">

  <div id="main">
     <p>5.1 通过简单的URLENCODE ＋ BASE64编码防止数据明文传输
5.2 对普通请求、返回数据，生成MD5校验（MD5中加入动态密钥），进行数据完整性（简单防篡改，安全性较低，优点：快速）校验。 
5.3 对于重要数据，使用RSA进行数字签名，起到防篡改作用。
5.4 对于比较敏感的数据，如用户信息（登陆、注册等），客户端发送使用RSA加密，服务器返回使用DES(AES)加密。</p>

<p>原因：客户端发送之所以使用RSA加密，是因为RSA解密需要知道服务器私钥，而服务器私钥一般盗取难度较大；如果使用DES的话，可以通过破解客户端获取密钥，安全性较低。而服务器返回之所以使用DES，是因为不管使用DES还是RSA，密钥（或私钥）都存储在客户端，都存在被破解的风险，因此，需要采用动态密钥，而RSA的密钥生成比较复杂，不太适合动态密钥，并且RSA速度相对较慢，所以选用DES）</p>

<p>把相关算法的代码也贴一下吧 （其实使用一些成熟的第三方库或许会来得更加简单，不过自己写，自由点）。注，这里的大部分加密算法都是参考一些现有成熟的算法，或者直接拿来用的。</p>

<p>1、MD5</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="sr">//</span><span class="err">因为是使用</span><span class="n">category</span><span class="err">，所以木有参数传入啦</span>

	<span class="o">-</span><span class="p">(</span><span class="no">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">stringFromMD5</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">self</span> <span class="o">==</span> <span class="kp">nil</span> <span class="o">||</span> <span class="p">[</span><span class="nb">self</span> <span class="n">length</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kp">nil</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="no">UTF8String</span><span class="p">];</span>
		<span class="n">unsigned</span> <span class="n">char</span> <span class="n">outputBuffer</span><span class="p">[</span><span class="no">CC_MD5_DIGEST_LENGTH</span><span class="p">];</span>
		<span class="no">CC_MD5</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">outputBuffer</span><span class="p">);</span>
		<span class="no">NSMutableString</span> <span class="o">*</span><span class="n">outputString</span> <span class="o">=</span> <span class="p">[[</span><span class="no">NSMutableString</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithCapacity</span><span class="ss">:CC_MD5_DIGEST_LENGTH</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
		<span class="k">for</span><span class="p">(</span><span class="no">NSInteger</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="no">CC_MD5_DIGEST_LENGTH</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">){</span>
		<span class="p">[</span><span class="n">outputString</span> <span class="n">appendFormat</span><span class="p">:</span><span class="err">@</span><span class="s2">"%02x"</span><span class="p">,</span><span class="n">outputBuffer</span><span class="p">[</span><span class="n">count</span><span class="p">]];</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">[</span><span class="n">outputString</span> <span class="n">autorelease</span><span class="p">];</span>
	<span class="p">}</span></code></pre></figure>

<p>2、Base64</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">	<span class="o">+</span> <span class="p">(</span><span class="no">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="ss">base64EncodeData: </span><span class="p">(</span><span class="no">NSData</span> <span class="o">*</span><span class="p">)</span> <span class="n">objData</span> <span class="p">{</span>
		<span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span> <span class="n">objRawData</span> <span class="o">=</span> <span class="p">[</span><span class="n">objData</span> <span class="n">bytes</span><span class="p">];</span>
		<span class="n">char</span> <span class="o">*</span> <span class="n">objPointer</span><span class="p">;</span>
		<span class="n">char</span> <span class="o">*</span> <span class="n">strResult</span><span class="p">;</span>

		<span class="sr">//</span> <span class="no">Get</span> <span class="n">the</span> <span class="no">Raw</span> <span class="no">Data</span> <span class="n">length</span> <span class="n">and</span> <span class="k">ensure</span> <span class="n">we</span> <span class="n">actually</span> <span class="n">have</span> <span class="n">data</span>
		<span class="n">int</span> <span class="n">intLength</span> <span class="o">=</span> <span class="p">[</span><span class="n">objData</span> <span class="n">length</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kp">nil</span><span class="p">;</span>

		<span class="sr">//</span> <span class="no">Setup</span> <span class="n">the</span> <span class="no">String</span><span class="o">-</span><span class="n">based</span> <span class="no">Result</span> <span class="n">placeholder</span> <span class="n">and</span> <span class="n">pointer</span> <span class="n">within</span> <span class="n">that</span> <span class="n">placeholder</span>
		<span class="n">strResult</span> <span class="o">=</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(((</span><span class="n">intLength</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">char</span><span class="p">));</span>
		<span class="n">objPointer</span> <span class="o">=</span> <span class="n">strResult</span><span class="p">;</span>

		<span class="sr">//</span> <span class="no">Iterate</span> <span class="n">through</span> <span class="n">everything</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">intLength</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="sr">//</span> <span class="n">keep</span> <span class="n">going</span> <span class="k">until</span> <span class="n">we</span> <span class="n">have</span> <span class="n">less</span> <span class="n">than</span> <span class="mi">24</span> <span class="n">bits</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">_base64EncodingTable</span><span class="p">[</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">_base64EncodingTable</span><span class="p">[((</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)];</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">_base64EncodingTable</span><span class="p">[((</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)];</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">_base64EncodingTable</span><span class="p">[</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">];</span>

		<span class="sr">//</span> <span class="n">we</span> <span class="n">just</span> <span class="n">handled</span> <span class="mi">3</span> <span class="n">octets</span> <span class="p">(</span><span class="mi">24</span> <span class="n">bits</span><span class="p">)</span> <span class="n">of</span> <span class="n">data</span>
		<span class="n">objRawData</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">intLength</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="sr">//</span> <span class="n">now</span> <span class="n">deal</span> <span class="n">with</span> <span class="n">the</span> <span class="n">tail</span> <span class="k">end</span> <span class="n">of</span> <span class="n">things</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">_base64EncodingTable</span><span class="p">[</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intLength</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">_base64EncodingTable</span><span class="p">[((</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)];</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">_base64EncodingTable</span><span class="p">[(</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">];</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="s1">'='</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">_base64EncodingTable</span><span class="p">[(</span><span class="n">objRawData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">];</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="s1">'='</span><span class="p">;</span>
		<span class="o">*</span><span class="n">objPointer</span><span class="o">++</span> <span class="o">=</span> <span class="s1">'='</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>

		<span class="sr">//</span> <span class="no">Terminate</span> <span class="n">the</span> <span class="n">string</span><span class="o">-</span><span class="n">based</span> <span class="n">result</span>
		<span class="o">*</span><span class="n">objPointer</span> <span class="o">=</span> <span class="s1">'\0'</span><span class="p">;</span>

		<span class="no">NSString</span> <span class="o">*</span><span class="n">rstStr</span> <span class="o">=</span> <span class="p">[</span><span class="no">NSString</span> <span class="n">stringWithCString</span><span class="ss">:strResult</span> <span class="n">encoding</span><span class="ss">:NSASCIIStringEncoding</span><span class="p">];</span>
		<span class="n">free</span><span class="p">(</span><span class="n">objPointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rstStr</span><span class="p">;</span>
	<span class="p">}</span></code></pre></figure>

<p>3、AES</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">	<span class="o">-</span><span class="p">(</span><span class="no">NSData</span><span class="o">*</span><span class="p">)</span> <span class="no">EncryptAES</span><span class="p">:</span> <span class="p">(</span><span class="no">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span> <span class="p">{</span>
		<span class="n">char</span> <span class="n">keyPtr</span><span class="p">[</span><span class="n">kCCKeySizeAES256</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">bzero</span><span class="p">(</span><span class="n">keyPtr</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">keyPtr</span><span class="p">));</span>

		<span class="p">[</span><span class="n">key</span> <span class="n">getCString</span><span class="ss">:keyPtr</span> <span class="n">maxLength</span><span class="ss">:sizeof</span><span class="p">(</span><span class="n">keyPtr</span><span class="p">)</span> <span class="n">encoding</span><span class="ss">:NSUTF8StringEncoding</span><span class="p">];</span>

		<span class="no">NSUInteger</span> <span class="n">dataLength</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">length</span><span class="p">];</span>

		<span class="n">size_t</span> <span class="n">bufferSize</span> <span class="o">=</span> <span class="n">dataLength</span> <span class="o">+</span> <span class="n">kCCBlockSizeAES128</span><span class="p">;</span>
		<span class="n">void</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">bufferSize</span><span class="p">);</span>

		<span class="n">size_t</span> <span class="n">numBytesEncrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="no">CCCryptorStatus</span> <span class="n">cryptStatus</span> <span class="o">=</span> <span class="no">CCCrypt</span><span class="p">(</span><span class="n">kCCEncrypt</span><span class="p">,</span> <span class="n">kCCAlgorithmAES128</span><span class="p">,</span>
		<span class="n">kCCOptionPKCS7Padding</span> <span class="o">|</span> <span class="n">kCCOptionECBMode</span><span class="p">,</span>
		<span class="n">keyPtr</span><span class="p">,</span> <span class="n">kCCBlockSizeAES128</span><span class="p">,</span>
		<span class="no">NULL</span><span class="p">,</span>
		<span class="p">[</span><span class="nb">self</span> <span class="n">bytes</span><span class="p">],</span> <span class="n">dataLength</span><span class="p">,</span>
		<span class="n">buffer</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">numBytesEncrypted</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cryptStatus</span> <span class="o">==</span> <span class="n">kCCSuccess</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">[</span><span class="no">NSData</span> <span class="n">dataWithBytesNoCopy</span><span class="ss">:buffer</span> <span class="n">length</span><span class="ss">:numBytesEncrypted</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">return</span> <span class="kp">nil</span><span class="p">;</span>
	<span class="p">}</span></code></pre></figure>

<p>4、RSA</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">	<span class="o">-</span> <span class="p">(</span><span class="no">NSData</span> <span class="o">*</span><span class="p">)</span> <span class="n">encryptWithData</span><span class="p">:(</span><span class="no">NSData</span> <span class="o">*</span><span class="p">)</span><span class="n">content</span> <span class="p">{</span>
		<span class="n">size_t</span> <span class="n">plainLen</span> <span class="o">=</span> <span class="p">[</span><span class="n">content</span> <span class="n">length</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plainLen</span> <span class="o">&gt;</span> <span class="n">maxPlainLen</span><span class="p">)</span> <span class="p">{</span>
		<span class="no">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s2">"content(%ld) is too long, must &lt; %ld"</span><span class="p">,</span> <span class="n">plainLen</span><span class="p">,</span> <span class="n">maxPlainLen</span><span class="p">);</span>
		<span class="k">return</span> <span class="kp">nil</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">void</span> <span class="o">*</span><span class="n">plain</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">plainLen</span><span class="p">);</span>
		<span class="p">[</span><span class="n">content</span> <span class="n">getBytes</span><span class="ss">:plain</span>
		<span class="n">length</span><span class="ss">:plainLen</span><span class="p">];</span>

		<span class="n">size_t</span> <span class="n">cipherLen</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span> <span class="sr">//</span> <span class="n">currently</span> <span class="no">RSA</span> <span class="n">key</span> <span class="n">length</span> <span class="n">is</span> <span class="n">set</span> <span class="n">to</span> <span class="mi">128</span> <span class="n">bytes</span>
		<span class="n">void</span> <span class="o">*</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">cipherLen</span><span class="p">);</span>

		<span class="no">OSStatus</span> <span class="n">returnCode</span> <span class="o">=</span> <span class="no">SecKeyEncrypt</span><span class="p">(</span><span class="n">publicKey</span><span class="p">,</span> <span class="n">kSecPaddingPKCS1</span><span class="p">,</span> <span class="n">plain</span><span class="p">,</span>
		<span class="n">plainLen</span><span class="p">,</span> <span class="n">cipher</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipherLen</span><span class="p">);</span>

		<span class="no">NSData</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">returnCode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="no">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s2">"SecKeyEncrypt fail. Error Code: %ld"</span><span class="p">,</span> <span class="n">returnCode</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="no">NSData</span> <span class="n">dataWithBytes</span><span class="ss">:cipher</span>
		<span class="n">length</span><span class="ss">:cipherLen</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">free</span><span class="p">(</span><span class="n">plain</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span></code></pre></figure>

<p>转自：<a href="http://bbs.9ria.com/thread-253254-1-1.html">http://bbs.9ria.com/thread-253254-1-1.html</a></p>

  </div>


<!-- 广告模块 -->
  <div id="asidepart">
      <aside class="clearfix">
        <div class="sponsor">
            <p class="asidetitle">广告</p>
            <a target="_blank" href="/"><img src="/res/21.pic.jpg" width="235px" height="200px"></a></div>
        <div class="categorieslist">
          <p class="asidetitle">分类</p>
          <ul>
            <li><a href="/" title="books summary">技术分享</a></li>
            <li><a href="/" title="iOS">闲暇扯蛋</a></li>
          </ul> </div>
      </aside>
    </div></div>
    
 </div>
    <!-- 底部内容 -->
<footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>木瓜</li>
          <li><a href="mailto:543518851@qq.com">邮箱:543518851@qq.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>这个个人博客，用于技术分享以及交流探讨～～
</p>
      </div>
    </div>

  </div>
</footer>

  </body>

</html>
